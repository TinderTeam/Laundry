//
//  ibehavior.js
//  <iBehavior
//
//  Created by l00175152 on 2011-11-08.
//  Copyright 2011 l00175152. All rights reserved.
//
(function($) {
	//setCookies();
	//ajaxState:???????????????ajax????????????????????????????????????
	//        none:      ?????????ajax
	//        loading???     ????????????
	//        completed???????????????
	var ajaxState = "none";
	//DOM?????????????????????document???????????????ajax?????????????????????????????????ajax?????????????????????????????????DomReady?????????????????????ajax????????????????????????????????????traceDomReady?????????????????????ajax??????????????????
	//?????????ajax?????????????????????????????????????????????????????????ajax??????????????????????????????????????????,???????????????????????????ajax???
	//DomReady??????????????????????????????????????????????????????ajaxStop?????????traceDomReady()????????????????????????????????????traceDomReady()
	$(document).ajaxStart(function() {
		ajaxState = "loading";
	});
	$(document).ajaxStop(function() {
		ajaxState = "completed";
	});
	var $iBehaviorClick = new Object(), $iBehaviorDomReady = new Object();
	//???????????????2????????????????????????a??????????????????????????????????????????????????????????????????????????????
	//???????????????????????????????????????????????????
	$(document).ready(function() {
		if($("#iBehaviorTrace").length != 0) {
			//???iBehaviorClick????????????????????????
			if($("#iBehaviorClick").length > 0) {
				//????????????ajax????????????????????????????????????????????????????????????????????????????????????????????????????????????
				$(document).ajaxStop(traceClick);
				//setTimeout(function(){traceClick()},2000);
				traceClick();

			}
		}
	});
	$(document).ready(function() {
		if($("#iBehaviorTrace").length != 0) {
			//???iBehaviorDomReady????????????????????????
			if($("#iBehaviorDomReady").length > 0) {
				if(ajaxState == "loading") {
					$(document).ajaxStop(traceDomReady);
				} else {
					traceDomReady();
				}
			}
		}
	});
	/*=======================================================
	 ????????????,??????????????????,????????????
	 */
	function traceClick() {
		$iBehaviorClick = $("#iBehaviorClick");
		bindVariableTags();
	}

	/*=======================================================
	 ?????????????????????????????????DomReady???????????????????????????
	 */
	function traceDomReady() {
		$iBehaviorDomReady = $("#iBehaviorDomReady");
		var constantUrlDomReady = "";
		//???????????????????????????????????????
		constantUrlDomReady = getConstantUrl($iBehaviorDomReady);
		//???????????????????????????
		traceBehaviorDomHandler(constantUrlDomReady);

	}

	/*=======================================================
	 ??????????????????????????????????????????????????????url
	 */
	function getConstantUrl($iBehaviorTrace) {
		var constantUrlPre = "";
		$iBehaviorTrace.find("#iBehaviorConstant").children().each(function() {
			var $thisSpan = $(this);
			constantUrlPre = constantUrlPre + "&" + $thisSpan.attr("wadimension") + "=" + encodeURIComponent($thisSpan.attr("wacontent"));
		});
		return constantUrlPre;
	}

	/*=======================================================
	 ?????????????????????????????????????????????????????????url????????????
	 */
	function getVariableUrl(event, $currentClick) {
		var ibResult = "";
		var ibTargetKey = event.data.key;
		var $ibTargetObject = $("#iBehaviorVariable").children();
		//?????????????????????
		$ibTargetObject.each(function(){
		if ($(this).attr("waselector")==ibTargetKey)
	{
				//???????????????
				var dimensionName = $(this).attr("wadimension");
				//?????????????????????
				var attrName = $(this).attr("targetattr");
				//??????????????????
				var attr = "";
				if(attrName == "text") {
					attr = encodeURIComponent($currentClick.text());
				} else {
					attr = encodeURIComponent($currentClick.attr(attrName));
				}
				//??????url
				ibResult = ibResult + "&" + dimensionName + "=" + attr;

		}
	});
		return ibResult;	
}

	/*=======================================================
	 ??????????????? ???????????????????????????????????????url????????????????????????????????????????????????
	 */
	function getUserDefinedUrl($iBehaviorTrace) {
		var userDefinedUrlPre = "";
		var attrValue = "";
		$iBehaviorTrace.find("#iBehaviorUserDefined").children().each(function() {
			var $spanDefined = $(this);
			var targetKeyDefined = $spanDefined.attr("waselector");
			var dimensionalNameDefined = $spanDefined.attr("wadimension");
			var targetAttrDefined = $spanDefined.attr("targetattr");
			if(targetAttrDefined == "text") {
				attrValue = $(targetKeyDefined).text();
			} else {
				attrValue = $(targetKeyDefined).attr(targetAttrDefined);
			}
			userDefinedUrlPre = userDefinedUrlPre + "&" + dimensionalNameDefined + "=" + encodeURIComponent(attrValue);
		});
		return userDefinedUrlPre;
	}

	/*=======================================================
	 ?????????????????????????????????????????????????????????????????????url
	 */
	function getConstantUrlOnClick(event, $iBehaviorTrace) {
		var constantUrlPre = "";
		$iBehaviorTrace.find("#iBehaviorConstant").children().each(function() {
			var $thisConSpan = $(this);
			var paramCounter = 0;
			for(withDimension in event.data.clickParams) {
				if(event.data.clickParams[paramCounter].withDimension == $thisConSpan.attr("wadimension")) {
					constantUrlPre = constantUrlPre + "&" + $thisConSpan.attr("wadimension") + "=" + encodeURIComponent($thisConSpan.attr("wacontent"));
				}
				paramCounter = paramCounter + 1;
			}
		});
		return constantUrlPre;
	}

	/*=======================================================
	 ?????????????????????????????????????????????????????????????????????????????????url
	 */
	function getUserDefinedUrlOnClick(event, $iBehaviorTrace) {
		var userDefinedUrlPre = "";
		var attrValue = "";
		$iBehaviorTrace.find("#iBehaviorUserDefined").children().each(function() {
			var $spanDefined = $(this);
			var paramCounter = 0;
			for(withDimension in event.data.clickParams) {
				if(event.data.clickParams[paramCounter].withDimension == $spanDefined.attr("wadimension")) {
					var targetKeyDefined = $spanDefined.attr("waselector");
					var dimensionalNameDefined = $spanDefined.attr("wadimension");
					var targetAttrDefined = $spanDefined.attr("targetattr");
					if(targetAttrDefined == "text") {
						attrValue = $(targetKeyDefined).text();
					} else {
						attrValue = $(targetKeyDefined).attr(targetAttrDefined);
					}
					userDefinedUrlPre = userDefinedUrlPre + "&" + dimensionalNameDefined + "=" + encodeURIComponent(attrValue);
				}
				paramCounter = paramCounter + 1;
			}
		});
		return userDefinedUrlPre;
	}

	/*=======================================================
	 ????????????????????????????????????click??????
	 */
	function bindVariableTags() {
		//?????????????????????????????????
		var params = parseMeta();
		//????????????????????????click??????
		var paramCount = 0;
		for(key in params) {
			//???????????????????????????????????????????????????????????????
			$(document).undelegate(params[paramCount].key, "click", traceBehaviorHandler);
			$(document).delegate(params[paramCount].key, "click", params[paramCount], traceBehaviorHandler);
			//$(document).off("click", params[paramCount].key, traceBehaviorHandler);
			//$(document).on("click", params[paramCount].key, params[paramCount], traceBehaviorHandler);
			//$(params[paramCount].key).unbind( "click", traceBehaviorHandler);
			//$(params[paramCount].key).bind("click", params[paramCount], traceBehaviorHandler);
			
			paramCount++;
		}
	}

	/*=======================================================
	 ????????????????????????????????????????????????span???????????????????????????????????????
	 */
	function parseMeta() {
		var ibParams = {};

		var paramCounter = 0;
		$iBehaviorClick.find("#iBehaviorVariable").children().each(function() {
			var $span = $(this);
			var withParamCounter = 0;
			var withParams = {};
			$span.children().each(function() {
				var $withSpan = $(this);
				withParams[withParamCounter] = {
					withDimension : $withSpan.attr("wadimension")
				}
				withParamCounter = withParamCounter + 1;
			});
			var targetKey = $span.attr("waselector");
			var dimensionalName = $span.attr("wadimension");
			var targetAttr = $span.attr("targetattr");
			ibParams[paramCounter] = {
				key : targetKey,
				dimension : dimensionalName,
				attrName : targetAttr,
				clickParams : withParams
			};
			paramCounter = paramCounter + 1;
		});
		return ibParams;
	}

	/*=========================================================================
	 ??????????????????????????????????????????
	 */
	function traceBehaviorHandler(event) {
		var $currentClickTag = $(this);
		//var $iBehaviorClick = $("#iBehaviorClick");
		var constantsUrl = getConstantUrlOnClick(event, $iBehaviorClick);
		var variableUrl = getVariableUrl(event, $currentClickTag);
		var userDefinedUrl = getUserDefinedUrlOnClick(event, $iBehaviorClick);
		var lastURL = constantsUrl + variableUrl + userDefinedUrl;
		//alert(lastURL);
		sendData(lastURL);
	}

	/*=========================================================================
	 ????????????????????????????????????????????????????????????????????????
	 */
	function traceBehaviorDomHandler(constantUrlDom) {
		var userDefinedUrl = getUserDefinedUrl($iBehaviorDomReady);
		var lastURL = constantUrlDom + userDefinedUrl;
		//alert(lastURL);
		sendData(lastURL);
	}

	//======================================================================
	//??????????????????sensor????????????????????????????????????
	function sendData(iBehaviorUrl) {
		var iBehavior = iBehaviorObj();
		iBehavior.v = {};
		iBehavior.v["result"] = iBehaviorUrl;
		iBehavior.send();
	}

	/*======================================================================
	 ?????????????????????????????????DOM??????????????????
	 */
	function iBehaviorObj() {
		var oTempIBehavior = new Object();
		oTempIBehavior.ct = "<img style='display:none' src=";
		oTempIBehavior.cd = iBehaviorCommonURL + "/ws/ibehavior";
		oTempIBehavior.cu = "/transmit/sensor?Log=1";
		oTempIBehavior.ce = ">";
		oTempIBehavior.d = {};
		oTempIBehavior.d["dt"] = document.title;
		oTempIBehavior.d["cb"] = new Date().getTime();
		//document.referrer="http://www.baidu.com/s?bs=%B0%D9%B6%C8&f=8&rsv_bp=1&rsv_spt=3&wd=%BB%AA%CE%AA+%B9%D9%CD%F8&inputT=2861";
		oTempIBehavior.d["dr"] = unescape(gb2utf_ib(document.referrer));		
		oTempIBehavior.vo = "";
		oTempIBehavior.send = function() {
			if( typeof oTempIBehavior.v != "undefined") {
				for(vKey in oTempIBehavior.v ) {
					oTempIBehavior.vo = oTempIBehavior.v[vKey];
				}
			}
			for(dKey in oTempIBehavior.d ) {
				oTempIBehavior.vo = oTempIBehavior.vo + "&" + dKey + "=" + encodeURIComponent(oTempIBehavior.d[dKey]);
			}
			var ib_script = document.createElement("script");
			ib_script.type = "text/javascript";
			ib_script.src = this.cd + this.cu + this.vo;
			setCookies();
			//alert(ib_script.src);
			setTimeout(function() {
				document.body.appendChild(ib_script);
				document.body.removeChild(ib_script);
			}, 0);
		}
		return oTempIBehavior;
	}

	function setCookies() {
		var x_trackingId = "v1st=";
		var c_start = document.cookie.indexOf(x_trackingId);
		//????????????v1st???????????????????????????visitor????????????sensor??????????????????????????????????????????
		if(c_start == -1) {
			var x_trackingIdValue = getUniCode();
			document.cookie = x_trackingId + escape(x_trackingIdValue) + "; expires=" + "Wed, 19 Feb 2020 14:28:00 GMT; domain=huawei.com; path=/;";
		}
	}

	//?????????????????????????????????16????????????????????????1???2???????????????????????????????????????????????????16-???????????????length?????????????????????????????????16????????????????????????????????????
	//?????????????????????????????????16??????????????????????????????????????????????????????16????????????????????????16????????????uniqid???
	function getUniCode() {
		var uniCode = new Date().getTime().toString(16);
		uniCode += Math.floor((1 + Math.random()) * Math.pow(16, (16 - uniCode.length))).toString(16).substr(1);
		return uniCode.toLocaleUpperCase();
	}

})(iBDom.query);
